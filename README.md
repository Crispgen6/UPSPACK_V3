# RPi UPSPack V3 产品使用指南

UPSPack v3 是在2020年9月发布的新一代树莓派UPS不间断电源扩展板的最新型号。根据以往v1和v2版本的迭代升级，v3版本是目前树莓派UPS供电最稳定的一种供电方案。

## 目录

* [版本差异](#版本差异)
* [安装驱动](#安装驱动)







### 功能升级

以下列出UPS v3版本和v2版本的产品差异：

| 功能特点                                      | RPi UPSPack V3版本                           | RPi UPSPack V2版本                        |
| --------------------------------------------- | -------------------------------------------- | :---------------------------------------- |
| 输入接口                                      | TYPE-C接口（兼容最新Pi4的电源线）            | Micro-USB接口（兼容Pi3及更老型号的Pi）    |
| 最大输出电流                                  | 5V 3A                                        | 5V 3A                                     |
| 外部停电，Pi持续供电（不重启）                | 支持                                         | 支持                                      |
| 硬件开停机开关                                | 有                                           | 有                                        |
| GPIO供电接口和UART、halt signal信号接口       | 有                                           | 有                                        |
| 锂电池电量统计                                | 支持                                         | 支持                                      |
| 开机低压检测                                  | 支持                                         | 不支持                                    |
| 电源适配器异常检测（停电时刻检测）            | 支持                                         | 支持                                      |
| USB-A座输出电压值检测                         | 支持                                         | 支持                                      |
| 电池耗尽前自动通知关机                        | 支持                                         | 支持                                      |
| 停电后，程序自动开机                          | 支持（无需人工干预，程序开机）               | 不支持（需人工干预开机）                  |
| 停电后，UPS自动切换成休眠模式                 | 支持                                         | 不支持                                    |
|                                               |                                              |                                           |
| **UPS与Pi的串口（UART）通讯：**               |                                              |                                           |
| 通讯设置                                      | 9600 bps 8N1                                 | 9600 bps 8N1                              |
| 协议版本号                                    | V3.1（及更高版本）                           | V1.0                                      |
| 协议向下兼容性                                | 兼容V2老版本的UPS通讯协议                    | 兼容                                      |
|                                               |                                              |                                           |
| **UPS与Pi的单总线通讯（System halt signal）** |                                              |                                           |
| 通讯IO口                                      | UPS主板的STA接口连接树莓派GPIO18（BCM 18）   | UPS主板的STA接口连接树莓派GPIO18（BCM18） |
| 通讯协议                                      | 脉冲方式                                     | 电平方式                                  |
| 软件兼容性                                    | V3采用脉冲检测更为可靠（与V2版本软件不兼容） | 电平检测方式                              |



### 硬件说明

#### 接口说明

![main_board](/image/main_board.JPG)

| 标号 | 名称                       | 描述                                                         |
| ---- | -------------------------- | ------------------------------------------------------------ |
| 1    | TYPE-C 电源适配器充电接口  | 外部5V电源对UPS进行供电的接口，供电需求5V 2A-3A              |
| 2    | USB-A 座                   | 2个USB-A座对树莓派主板进行供电。                             |
| 3    | LED 电量指示灯             | 4个LED灯（D1-D4）用于指示锂电池的当前电量                    |
| 4    | TP 主板测试口              | 工厂用于烧录程序和测试主板。该接口对用户无用。               |
| 5    | 新塘MCU控制器              | 用于充放电路径管理，和树莓派主板相互通讯等功能。             |
| 6    | 双PMU（Power Manger Unit） | 2颗锂电池充电和放电芯片（芯片带散热片，已加密）              |
| 7    | PH2.0 锂电池输入接口       | 只支持1S 3.7V锂电池，可兼容3.7V18650 / 21700等电池组（要求电池组电压为3.7V 容量大小不限制） |
| 8    | UPS输出总开关              | ON / OFF 开关，当开关打到ON后，UPS输出5V电源给予树莓派主板。OFF则反之。 |
| 9    | 2.54mm排针口               | 3P排针口：分别为单线通讯和UART接口，用于连接树莓派主板的GPIO口，进行通讯。<br />2P电源口：通过树莓派GPIO电源接口进行5V供电。（需要优质硅胶线，减小内阻）<br />产品默认赠送排针，玩家如需使用到以上接口，可以选择性焊接。 |
| 10   | 电源输出LED灯              | 当输出5V稳定后，LED灯亮起。                                  |



#### 电池接口

UPS主板的电池接口：**PH2.0座**。产品出厂配套的电池组内部已集成锂电池保护板。如用户想自行接入DIY的电池包，请注意以下几个注意事项：

* 电池输出线的接口为PH 2.0 公头，**注意接口的正极和负极！如电池线接反，UPS将会烧毁！**

* 自主电池组为1S 3.7V锂电池：标准额定电压3.7V，充满电压4.2V。常规兼容型号：18650、21700等锂电池。**不兼容磷酸铁锂电池。**

* 容量无特别要求，但考虑到Pi4续航，最佳容量最好大于4000mAh

* 自己组装的电池组尽量带6A及以上大电流锂电池保护板：市面上常规的锂电池保护板参数为3A-4A，当外部需要大电流时，电流太小的保护板可能会导致电池输出异常。

![bat_info](\image\bat_info.jpg)

  

#### 通讯与电源接口

UPS V3 与树莓派通讯，采用2种方式：UART接口和STA单总线接口。STA单总线接口简单灵活，只需要在pi上通过任意一个闲置的GPIO口（提供的Pi端python程序默认为：GPIO 18，玩家可自行更改）和UPS就能进行通讯。UART接口则可以让PI读取更为丰富的UPS目前工作信息。

2个接口的作用如下：

* UART接口：UPS和树莓派的板载串口进行通讯。树莓派可以得到的信息：通讯心跳包、外部是否停电、电池容量百分比、向外输出电压值。
* STA单总线接口：UPS主板在电池耗尽之前发送给树莓派主板一个脉冲信息（Halt signal），让树莓派安全的进行软件关机。当树莓派安全关机后，再次切断树莓派的5V主供电电源。（USB-A座和2P排针座都受程序控制）。当外部电源恢复后，UPS主板会自动进入充电流程，当电池充电到达一定容量，会自动对树莓派恢复供电。

![gpio](\image\gpio.jpg)











### 安装驱动

1. 把产品配套的资料包，解压缩到 `/home/pi/UPSPACK_V3` 目录下。检查**shutdown_check.py**的完整目录是

    > **shutdown_check.py**完整目录为如下：
    >
    > /home/pi/UPSPACK_V3/shutdown_check.py

2.  更改`/etc/rc.local`，把自动关机的程序添加成开机自动启动

    > ```shell
    > sudo nano /etc/rc.local
    > 
    > #在最下面的 exit 的上面一行添加如下内容
    > 
    > sudo python3 /home/pi/UPSPACK_V3/shutdown_check.py &
    > ```

3. 完成以上步骤，即可实现当电池耗尽前，树莓派自动安全关机的功能。并且当外部恢复电源，UPS板子会自动进行充电。当电池充电到一定电量后，UPS会自动开启树莓派的电源。
