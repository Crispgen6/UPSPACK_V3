# RPi UPSPack V3 产品使用指南

UPSPack v3 是在2020年9月发布的新一代树莓派UPS不间断电源扩展板的最新型号。根据以往v1和v2版本的迭代升级，v3版本是目前树莓派UPS供电最稳定的一种供电方案。以下列出v3版本和v2版本的产品差异：



| 功能特点                                      | RPi UPSPack V3版本                           | RPi UPSPack V2版本                     |
| --------------------------------------------- | -------------------------------------------- | -------------------------------------- |
| 输入接口                                      | TYPE-C接口（兼容最新Pi4的电源线）            | Micro-USB接口（兼容Pi3及更老型号的Pi） |
| 最大输出电流                                  | 5V 3A                                        | 5V 3A                                  |
| 外部停电，Pi持续供电（不重启）                | 支持                                         | 支持                                   |
| 硬件开停机开关                                | 有                                           | 有                                     |
| GPIO供电接口和UART、halt signal信号接口       | 有                                           | 有                                     |
| 锂电池电量统计                                | 支持                                         | 支持                                   |
| 开机低压检测                                  | 支持                                         | 不支持                                 |
| 电源适配器异常检测（停电时刻检测）            | 支持                                         | 支持                                   |
| USB-A座输出电压值检测                         | 支持                                         | 支持                                   |
| 电池耗尽前自动通知关机                        | 支持                                         | 支持                                   |
| 停电后，程序自动开机                          | 支持（无需人工干预，程序开机）               | 不支持（需人工干预开机）               |
| 停电后，UPS自动切换成休眠模式                 | 支持                                         | 不支持                                 |
|                                               |                                              |                                        |
| **UPS与Pi的串口（UART）通讯：**               |                                              |                                        |
| 通讯设置                                      | 9600 bps 8N1                                 | 9600 bps 8N1                           |
| 协议版本号                                    | V3.1（及更高版本）                           | V1.0                                   |
| 协议向下兼容性                                | 兼容V2老版本的UPS通讯协议                    | 兼容                                   |
|                                               |                                              |                                        |
| **UPS与Pi的单总线通讯（System halt signal）** |                                              |                                        |
| 通讯IO口                                      | UPS主板的STA接口，树莓派上BCM 18脚           | UPS主板的STA接口，树莓派上BCM 18脚     |
| 通讯协议                                      | 脉冲方式                                     | 电平方式                               |
| 软件兼容性                                    | V3采用脉冲检测更为可靠（与V2版本软件不兼容） | 电平检测方式                           |



### 安装驱动

1. 把产品配套的资料包，解压缩到 `/home/pi/UPSPACK_V3` 目录下。检查**shutdown_check.py**的完整目录是

    > **shutdown_check.py**完整目录为如下：
    >
    > /home/pi/UPSPACK_V3/shutdown_check.py

2.  更改`/etc/rc.local`，把自动关机的程序添加成开机自动启动

    > ```shell
    > sudo nano /etc/rc.local
    > 
    > #在最下面的 exit 的上面一行添加如下内容
    > 
    > sudo python3 /home/pi/UPSPACK_V3/shutdown_check.py &
    > ```

3. 完成以上步骤，即可实现当电池耗尽前，树莓派自动安全关机的功能。并且当外部恢复电源，UPS板子会自动进行充电。当电池充电到一定电量后，UPS会自动开启树莓派的电源。
